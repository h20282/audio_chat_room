### 一、 设计目的 

#### 1.1功能与要求

该项目由为CS架构，分为客户端和服务端，用于实现多人在线语音聊天，具体需求如下。

**账号系统**

1. 支持用户注册，登录和退出。
2. 用户注册需要提供用户名和密码，用户名不可重复。

**房间**

1. 用户登录后可以创建房间，每个房间有且只有一个主持人，创建者默认为主持人，主持人可以转让给其他人。
2. 房间可以同时存在多个。
3. 房间内的用户可以听到其他用户的声音。
4. 主持人可以将若干指定用户静音，静音后所有用户不再听到被静音用户的声音，被静音用户可以主动解除静音。
5. 主持人可以将若干指定用户踢出房间。
6. 房间存在一个唯一6位数字ID，登录用户可以输入该ID加入一个房间。
7. 登录用户可以查看当前所有房间，并可选择其中一个加入。
8. 主持人退出后，房间自动解散，其他人自动退出房间。

**语音聊天**

1. 用户可以指定声音来源（包括麦克风和扬声器，可能有多个）。
2. 在正常网络下，声音每分钟明显卡顿次数小于1次，无明显延迟感。
3. 用户可以关闭房间内指定用户的声音。
4. 用户可以调节房间内指定用户的音量。

#### 1.2 环境选择

客户端的实现使用的是**Windows10**操作系统下的**QT5.12.5**, Qt是一个多平台的C++图形用户界面应用程序框架。

服务器使用的是**ubuntu18.04**,64位版本,同样安装qt作为开发环境;

数据库使用的是Linux **MySQL5.7**。

### 二、实现

#### 2.1网络模块

由于音频占用带宽不大，项目考虑采用**udp**协议。

定义函数：

- 网络初始化init();
- 连接到服务器connectToServer();
- 发送数据：sendData();
- 看情况是否需要自定义udp协议解决出现问题。

#### 2.2数据库

首先创建数据库，添加**用户表**user,包含id、用户名、密码、创建时间、最后登录时间等。

```mysql
create table user (
    id bigint unsigned AUTO_INCREMENT primary key,
    username varchar (30),
    passwd varchar(30),
	Createtime DATETIME,
	LastLoginTime DATETIME)ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

![image-20210806115554903](C:\Users\user\Desktop\设计文档.assets\image-20210806115554903.png)



添加**房间表**room,包含房间号、主持人、创建时间等。

```mysql
create table room (
    roomId bigint unsigned AUTO_INCREMENT primary key,
    roomNum int unique key,
    roomOwner varchar (30),
	Createtime DATETIME)ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

创建房间用户记录表roomUser，包含房间id、用户id。

```mysql
create table roomUser (
    roomUserId bigint unsigned AUTO_INCREMENT primary key,
    rNum int unique key,
    uId int unique key,
	)ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

创建外键，关联房间表和用户记录表。

```mysql
alter table roomUser add foreign key (rNum) references room (roomNum) on delete cascade on update cascade;
alter table roomUser add foreign key (uId) references TBCourse (id) on delete set null on update cascade;
```

#### 2.3登录和注册界面

![image-20210806115503046](C:\Users\user\Desktop\设计文档.assets\image-20210806115503046.png)

![image-20210806115518295](C:\Users\user\Desktop\设计文档.assets\image-20210806115518295.png)

登录注册，单击登录和注册窗口时发送信号，将用户名和密码传输给服务器。

```c++
SIG_loginCommit(QString name , QString password);
SIG_registerCommit(QString name , QString passord);
```

服务器收到内容后做进一步处理。

- 关于登录, 处理登录请求, 先根据用户名查表取密码, 如果没有, 那么没有该用户；有的话, 比对密码 是否一致, 不一致, 返回密码错误, 一致返回登录成功。
- 关于注册，根据用户名判断是否重复，没有重复的话验证两次密码输入是否一致，一致的话通过md5加密后存入数据库，返回登录界面。
- 除此之外，登录后还需要有获取房间列表功能。

登录加密的方法:

- MD5加密
- 验证码防止脚本攻击
- 记录上次登录ip，地址等进行安全提示
- 手机验证码
- 绑定微信扫一扫登录
- 人脸识别。。。

#### 2.3会议模块

##### 2.3.1创建房间

![image-20210806161236209](C:\Users\user\Desktop\设计文档.assets\image-20210806161236209.png)
客户端单击星星图标发送信号，向服务端发送创建房间请求，服务器随机生成房间号返回。

```
SIG_createRoom();
```

##### 2.3.2加入房间

客户端搜索房间号或单击房间列表中的房间发送信号，向服务端发送加入房间请求，服务器客户端添加至房间列表，给房间的每一个客户端发送成员列表。

```
SIG_joinRoom(int num);
```



![image-20210806162521048](C:\Users\user\Desktop\设计文档.assets\image-20210806162521048.png)

##### 2.3.3退出房间

客户端单击x或者退出房间时回收房间资源，发送信号，服务器收到某客户端退出房间的请求后，查找房间，得到用户列表,向每一个客户端发送客户端退出房间提示，每一个客户端接受后删除退出的客户端的资源。

```c++
SIG_quitRoom();//客户端向服务器发出退出信号
SIG_clientQuit();//服务器向客户端发出某个客户端退出信号
```

#### 2.4服务器模块



#### 2.5音频模块

##### 2.5.1基本流程和概念

要求：低延时（500ms以内）。

对于音频，需要采集电脑麦克风声音，采用QAudioInput和QAudioOutput模块完成。

音频方面需要**编码后再传输**，编码选择 **ffmpeg** 进行处理。此外，还需要考虑一些问题：**回音消除、降噪、抑制声音断断续续、静音检测、混音**等。

音频的主要流程：

**语音采集->编码->网络通道->解码->语音播放。**

![image-20210806164059828](C:\Users\user\Desktop\设计文档.assets\image-20210806164059828.png)

​        语音采集指的是从麦克风采集音频数据，即声音样本转换成数字信号。但是不经过编码会占用一定带宽，因此在实际的语音通话应用中，编码 这个环节是不可缺少的。目前有很多常用的语音编码技术，像 **G.729、G.711、iLBC、AAC、SPEEX** 等等。

​        当一个音频帧完成编码后，即可通过网络发送给通话的对方。对于语音对话这样 Realtime 应用， 低延迟和平稳是非常重要的，这就要求我们的**网络传送非常顺畅**。

​       当对方接收到编码帧后，会对其进行**解码**，以恢复成为可供声卡直接播放的数据。完成解码后，即可将得到的音频帧提交给声卡进行播放。

TODO：

​        一个“效果良好”的语音对话系统应该达到如下几点：**低延迟，背景噪音小，声音流畅不卡顿，没有回音**。

- 低延迟保证双方可以实时对话。主要取决于网络的速度和通话双方的物理位置的距离，就单纯软件的角度，优化的可能性很小。
- 回音消除：
  - 扬声器播放时，电脑外部声音被麦克风再次采集，造成回音。 回音消除的原理简单地来说就是，回音消除模块依据刚播放的音频帧，在采集的音频帧中做一些**类似抵消的运算**，从而将回声从采集帧中清除掉。这个过程是相当复杂的，因为它还与你聊天时所处的房间的大小、以及你在房间中的位置有关，因为这些信息决定了声波反射的时长。智能的回音消除模块，能动态调整内部参数，以最佳适应当前的环境。**现在做的比较好的回音消除有：webrtc。**
- 噪声抑制：
  - 噪声抑制又称为降噪处理，是根据语音数据的特点，将属于背景噪音的部分识别出来，并从音频帧中过滤掉。有很多**编码器都内置**了该功能。
- 抖动缓冲区：
  - 抖动缓冲区（JitterBuffer）用于**解决网络抖动**的问题。所谓网络抖动，就是**网络延迟一会大一会小**， 在这种情况下，即使发送方是定时发送数据包的（比如每 100ms 发送一个包），而接收方的接收就无法同样定时了，有时一个周期内一个包都接收不到，有时一个周期内接收到好几个包。如此，导致接收方听到的声音就是一卡一卡的。 JitterBuffer 工作于解码器之后，语音播放之前的环节。即语音解码完成后，将解码帧放入 JitterBuffer，声卡的播放回调到来时，从 JitterBuffer 中取出最老的一帧进行播放。 **JitterBuffer 的缓冲深度取决于网络抖动的程度**，网络抖动越大，缓冲深度越大，播放音频的延迟 就越大。所以，**JitterBuffer 是利用了较高的延迟来换取声音的流畅播放的**，因为相比声音一卡一卡来 说，稍大一点的延迟但更流畅的效果，其主观体验要更好。 当然，JitterBuffer 的缓冲深度不是一直不变的，而是根据网络抖动程度的变化而动态调整的。当 网络恢复到非常平稳通畅时，缓冲深度会非常小，这样因为 JitterBuffer 而增加的播放延迟就可以忽略不计了。
- 静音检测：
  -  静音检测通常也**集成在编码模块**中。静音检测算法结合前面的噪声抑制算法，可以识别出当前是否有语音输入，**如果没有语音输入，就可以编码输出一个特殊的的编码帧（比如长度为 0）**。特别是在多人视频会议中，通常只有一个人在发言，这种情况下，利用静音检测技术而节省带宽还是非常可观的。
- 混音：
  在视频会议中，多人同时发言时，我们需要同时播放来自于多个人的语音数据，**而声卡播放的缓冲区只有一个，所以，需要将多路语音混合成一路**，这就是混音算法要做的事情。

##### 2.5.2带宽计算

以采样率48KHz，采样位数16bit，双声道计算无损无压缩格式位1536kbps。

考虑采用ffmpeg对音频进行压缩，大概能压缩到128kbps左右。





视频加音频，就是 **3,981,312 bps** + 192 kbps = 4,080 kbps。





#### 2.6视频模块

注意区分Mb和MB，小写b是bit，大写B是字节。1B=8bit。

以1920x1080的1080p视频计算，需要1920×1080=2,073,600，大约200w像素点，每个像素点包含RGB3字节工24bit，因此总共49,766,400bit，约5.9MB。以24fps计算，约**1,194,393,600‬bit=149,299,200‬byte**（8bit 比特=1byte 字节），就是142MB。

![image-20210806171457257](C:\Users\user\Desktop\设计文档.assets\image-20210806171457257.png)

YUV代表亮度和色度，因为**RGB不利于压缩**。**通常用的是YUV4:2:0的采样方式**，能获得1/2的压缩率。

目前比较流行的编码格式有H.264，H.265。后者可以达到300的压缩率。**码流（视频文件在单位时间内使用的数据流量）**就是：**1,194,393,600‬bit ÷ 300 = 3,981,312 bit/s=3888Kbs**。



如果要做的话可以考虑opencv。

### 三、接口设计

#### 3.1数据库接口设计



#### 3.2用户接口设计



#### 3.3房间接口设计



#### 3.4音频接口设计

### 四、总结

























































